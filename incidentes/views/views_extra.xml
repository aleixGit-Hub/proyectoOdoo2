<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ====================================================================
         VISTA B√öSQUEDA AVANZADA ‚Äì PARTE
    ==================================================================== -->
    <record id="view_parte_search" model="ir.ui.view">
        <field name="name">parte.search</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <search string="Buscar Partes">
                <!-- Campos de b√∫squeda libre -->
                <field name="alumno_id"   string="Alumno"/>
                <field name="profesor_id" string="Profesor"/>
                <field name="grupo_id"    string="Grupo"/>
                <field name="ubicacion"   string="Ubicaci√≥n"/>
                <field name="name"        string="Referencia"/>

                <!-- Filtros predefinidos -->
                <separator/>
                <filter name="pendientes"
                        string="üìû Pendientes"
                        domain="[('gravedad', '=', 'pendiente')]"/>
                <filter name="completados"
                        string="‚úÖ Completados"
                        domain="[('gravedad', '=', 'completado')]"/>
                <filter name="cerrados"
                        string="üîí Cerrados"
                        domain="[('gravedad', '=', 'cerrado')]"/>
                <separator/>
                <filter name="con_expulsion"
                        string="üö® Con Expulsi√≥n"
                        domain="[('tiene_expulsion', '=', True)]"
                        groups="incidentes.group_parte_manager"/>
                <filter name="este_anio"
                        string="Este a√±o"
                        domain="[('fecha_hora', '&gt;=', (context_today() + relativedelta(month=1, day=1)).strftime('%Y-%m-%d'))]"/>
                <filter name="hoy"
                        string="Hoy"
                        domain="[('fecha_hora', '&gt;=', context_today().strftime('%Y-%m-%d')),
                                 ('fecha_hora', '&lt;',  (context_today() + relativedelta(days=1)).strftime('%Y-%m-%d'))]"/>

                <!-- Agrupaciones -->
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter name="grupo_by_grupo"     string="Grupo"          context="{'group_by': 'grupo_id'}"/>
                    <filter name="grupo_by_alumno"    string="Alumno"         context="{'group_by': 'alumno_id'}"/>
                    <filter name="grupo_by_profesor"  string="Profesor"       context="{'group_by': 'profesor_id'}"/>
                    <filter name="grupo_by_gravedad"  string="Estado llamada" context="{'group_by': 'gravedad'}"/>
                    <filter name="grupo_by_ubicacion" string="Ubicaci√≥n"      context="{'group_by': 'ubicacion'}"/>
                    <filter name="grupo_by_mes"       string="Mes"            context="{'group_by': 'fecha_hora:month'}"/>
                </group>
            </search>
        </field>
    </record>


    <!-- ====================================================================
         VISTA KANBAN ‚Äì PARTE
    ==================================================================== -->
    <record id="view_parte_kanban" model="ir.ui.view">
        <field name="name">parte.kanban</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <kanban default_group_by="gravedad"
                    class="o_kanban_small_column"
                    sample="1">

                <field name="name"/>
                <field name="alumno_id"/>
                <field name="grupo_id"/>
                <field name="profesor_id"/>
                <field name="gravedad"/>
                <field name="estado"/>
                <field name="fecha_hora"/>
                <field name="tiene_expulsion"/>
                <field name="ubicacion"/>

                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click
                            #{record.tiene_expulsion.raw_value ? 'border border-danger' : ''}">

                            <div class="oe_kanban_content">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong class="o_kanban_record_title">
                                        <field name="alumno_id"/>
                                    </strong>
                                    <span t-if="record.tiene_expulsion.raw_value"
                                          class="badge badge-pill badge-danger">
                                        üö® EXPULSI√ìN
                                    </span>
                                </div>

                                <div class="text-muted small">
                                    <i class="fa fa-users"/> <field name="grupo_id"/>
                                </div>

                                <div class="text-muted small">
                                    <i class="fa fa-map-marker"/> <field name="ubicacion"/>
                                </div>

                                <div class="text-muted small">
                                    <i class="fa fa-calendar"/>
                                    <field name="fecha_hora" widget="date"/>
                                </div>

                                <hr class="mt-1 mb-1"/>

                                <div class="d-flex justify-content-between">
                                    <span>
                                        <field name="estado" widget="badge"
                                               decoration-info="estado == 'borrador'"
                                               decoration-warning="estado == 'comunicado'"
                                               decoration-danger="estado == 'sancionado'"
                                               decoration-success="estado == 'cerrado'"/>
                                    </span>
                                    <span class="text-muted small">
                                        <i class="fa fa-user-circle"/>
                                        <field name="profesor_id"/>
                                    </span>
                                </div>
                            </div>

                            <div class="oe_kanban_footer">
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <span t-if="record.gravedad.raw_value == 'pendiente'"
                                              class="badge badge-warning"> Pendiente</span>
                                        <span t-elif="record.gravedad.raw_value == 'completado'"
                                              class="badge badge-success"> Completado</span>
                                        <span t-else=""
                                              class="badge badge-secondary"> Cerrado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>


    <!-- ====================================================================
         VISTA CALENDARIO ‚Äì PARTE
    ==================================================================== -->
    <record id="view_parte_calendar" model="ir.ui.view">
        <field name="name">parte.calendar</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <calendar string="Calendario de Partes"
                      date_start="fecha_hora"
                      color="gravedad"
                      quick_add="False"
                      mode="month">
                <field name="alumno_id"/>
                <field name="grupo_id"/>
                <field name="gravedad"/>
                <field name="profesor_id"/>
                <field name="ubicacion"/>
            </calendar>
        </field>
    </record>


    <!-- ====================================================================
         VISTAS GR√ÅFICO ‚Äì PARTE
    ==================================================================== -->
    <record id="view_parte_graph_gravedad" model="ir.ui.view">
        <field name="name">parte.graph.gravedad</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <graph string="Partes por Estado de Llamada" type="bar" sample="1">
                <field name="gravedad" type="row"/>
                <field name="grupo_id" type="col"/>
            </graph>
        </field>
    </record>

    <record id="view_parte_graph_grupo" model="ir.ui.view">
        <field name="name">parte.graph.grupo</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <graph string="Partes por Grupo" type="pie" sample="1">
                <field name="grupo_id" type="row"/>
            </graph>
        </field>
    </record>

    <record id="view_parte_graph_ubicacion" model="ir.ui.view">
        <field name="name">parte.graph.ubicacion</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <graph string="Partes por Ubicaci√≥n" type="bar" sample="1">
                <field name="ubicacion" type="row"/>
                <field name="gravedad"  type="col"/>
            </graph>
        </field>
    </record>

    <record id="view_parte_graph_mes" model="ir.ui.view">
        <field name="name">parte.graph.mes</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <graph string="Evoluci√≥n mensual de Partes" type="line" sample="1">
                <field name="fecha_hora" type="row" interval="month"/>
                <field name="gravedad"   type="col"/>
            </graph>
        </field>
    </record>

    <record id="view_parte_pivot" model="ir.ui.view">
        <field name="name">parte.pivot</field>
        <field name="model">parte</field>
        <field name="arch" type="xml">
            <pivot string="An√°lisis de Partes" sample="1">
                <field name="grupo_id"  type="row"/>
                <field name="gravedad"  type="col"/>
                <field name="alumno_id" type="row"/>
            </pivot>
        </field>
    </record>


    <!-- ====================================================================
         ACCIONES PARA EL PANEL DE DIRECTIVOS
    ==================================================================== -->
    <record id="action_estadisticas_gravedad" model="ir.actions.act_window">
        <field name="name">üìä Partes por Estado de Llamada</field>
        <field name="res_model">parte</field>
        <field name="view_mode">graph,pivot</field>
        <field name="view_id" ref="view_parte_graph_gravedad"/>
        <field name="groups_id" eval="[(4, ref('incidentes.group_parte_manager'))]"/>
    </record>

    <record id="action_estadisticas_grupo" model="ir.actions.act_window">
        <field name="name">ü•ß Partes por Grupo</field>
        <field name="res_model">parte</field>
        <field name="view_mode">graph,pivot</field>
        <field name="view_id" ref="view_parte_graph_grupo"/>
        <field name="groups_id" eval="[(4, ref('incidentes.group_parte_manager'))]"/>
    </record>

    <record id="action_estadisticas_ubicacion" model="ir.actions.act_window">
        <field name="name">üìç Partes por Ubicaci√≥n</field>
        <field name="res_model">parte</field>
        <field name="view_mode">graph,pivot</field>
        <field name="view_id" ref="view_parte_graph_ubicacion"/>
        <field name="groups_id" eval="[(4, ref('incidentes.group_parte_manager'))]"/>
    </record>

    <record id="action_estadisticas_mes" model="ir.actions.act_window">
        <field name="name">üìà Evoluci√≥n Mensual</field>
        <field name="res_model">parte</field>
        <field name="view_mode">graph,pivot</field>
        <field name="view_id" ref="view_parte_graph_mes"/>
        <field name="groups_id" eval="[(4, ref('incidentes.group_parte_manager'))]"/>
    </record>

    <record id="action_open_parte_all_views" model="ir.actions.act_window">
        <field name="name">Gesti√≥n de Partes</field>
        <field name="res_model">parte</field>
        <field name="view_mode">tree,kanban,calendar,graph,pivot,form</field>
        <field name="search_view_id" ref="view_parte_search"/>
    </record>


    <!-- ====================================================================
         MEN√ö ESTAD√çSTICAS ‚Äì solo manager
    ==================================================================== -->
    <menuitem id="menu_estadisticas"
              name="üìä Estad√≠sticas"
              parent="menu_principal"
              sequence="5"
              groups="incidentes.group_parte_manager"/>

    <menuitem id="menu_stats_gravedad"
              name="Por Estado de Llamada"
              parent="menu_estadisticas"
              action="action_estadisticas_gravedad"
              sequence="1"
              groups="incidentes.group_parte_manager"/>

    <menuitem id="menu_stats_grupo"
              name="Por Grupo"
              parent="menu_estadisticas"
              action="action_estadisticas_grupo"
              sequence="2"
              groups="incidentes.group_parte_manager"/>

    <menuitem id="menu_stats_ubicacion"
              name="Por Ubicaci√≥n"
              parent="menu_estadisticas"
              action="action_estadisticas_ubicacion"
              sequence="3"
              groups="incidentes.group_parte_manager"/>

    <menuitem id="menu_stats_mes"
              name="Evoluci√≥n Mensual"
              parent="menu_estadisticas"
              action="action_estadisticas_mes"
              sequence="4"
              groups="incidentes.group_parte_manager"/>

</odoo>
